<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Vietnam Routing Map</title>
    <link href="./maplibre-gl.css" rel="stylesheet" />
    <script src="./maplibre-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        font-family: system-ui, sans-serif;
      }
      #map {
        flex: 3;
        height: 100%;
      }
      #info {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: #f7f7f7;
        border-left: 1px solid #ccc;
      }
      h3 {
        margin-top: 0;
      }
      .step {
        padding: 8px;
        margin-bottom: 6px;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .step:hover {
        background: #e6f7ff;
      }
      #toggle-style-btn,
      #gps-btn {
        position: absolute;
        right: 10px;
        background: white;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 999;
      }
      #toggle-style-btn {
        top: 10px;
      }
      #gps-btn {
        top: 50px;
        background: #007bff;
        color: white;
      }
      #currentRoad {
        margin-top: 8px;
        font-weight: 500;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="info">
      <h3>H∆∞·ªõng ƒëi chi ti·∫øt</h3>
      <div id="directions"></div>
      <div id="currentRoad"></div>
      <p><b>H∆∞·ªõng d·∫´n:</b><br />Click ch·ªçn <b>ƒëi·ªÉm b·∫Øt ƒë·∫ßu</b> ‚Üí <b>ƒëi·ªÉm ƒë·∫øn</b></p>
    </div>

    <button id="toggle-style-btn">ƒê·ªïi ki·ªÉu b·∫£n ƒë·ªì</button>
    <button id="gps-btn">üöó GPS Follow</button>

    <script>
      // ======== C·∫•u h√¨nh b·∫£n ƒë·ªì ========
      const styles = {
        // street: "https://api.maptiler.com/maps/019a1f4a-6740-728b-bfa1-0f978746eba7/style.json?key=P6QaWC41SOB6NaqDUCk2&mtsid=02f3288c-3462-47d9-a75b-7b901e20448b",
        // street: "http://localhost:8080/styles/streets-simple/style.json",
        // street: "http://localhost:8080/styles/streets-v4/style.json",
        // street: "http://localhost:8080/styles/osm-bright/style.json",
        street: "http://localhost:8080/styles/maptiler-basic/style.json",
        dark: "https://demotiles.maplibre.org/style.json",
        satellite: "https://api.maptiler.com/maps/hybrid/style.json?key=YOUR_MAPTILER_KEY",
      };
      let currentStyle = "street";

      const map = new maplibregl.Map({
        container: "map",
        style: styles.street,
        center: [106.7009, 10.7765], // HCM
        // center: [105.724, 9.2941], // üß≠ Trung t√¢m TP. B·∫°c Li√™u
        zoom: 13,
      });
      map.addControl(new maplibregl.NavigationControl());

      // ======== Bi·∫øn l∆∞u ƒëi·ªÉm ========
      let start = null;
      let end = null;
      let startMarker, endMarker;
      let routeCoords = [];
      let stepsData = [];

      // ======== Khi click tr√™n b·∫£n ƒë·ªì ========
      map.on("click", (e) => {
        if (!start) {
          start = [e.lngLat.lng, e.lngLat.lat];
          startMarker = new maplibregl.Marker({ color: "green" }).setLngLat(start).addTo(map);
        } else if (!end) {
          end = [e.lngLat.lng, e.lngLat.lat];
          endMarker = new maplibregl.Marker({ color: "red" }).setLngLat(end).addTo(map);
          getRoute(start, end);
        } else {
          // Reset
          start = end = null;
          if (startMarker) startMarker.remove();
          if (endMarker) endMarker.remove();
          if (map.getLayer("route")) map.removeLayer("route");
          if (map.getSource("route")) map.removeSource("route");
          document.getElementById("directions").innerHTML = "";
          document.getElementById("currentRoad").innerText = "";
        }
      });

      // ======== L·∫•y tuy·∫øn ƒë∆∞·ªùng t·ª´ OSRM ========
      async function getRoute(start, end) {
        // const url = `http://192.168.1.6:3000/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson&steps=true`;
        const url = `http://localhost:3000/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson&steps=true`;
        const res = await fetch(url);
        const data = await res.json();
        const route = data.routes[0];
        routeCoords = route.geometry.coordinates.map((c) => ({
          lng: c[0],
          lat: c[1],
        }));
        stepsData = route.legs[0].steps;

        drawRoute(route.geometry);
        fitToRoute(route.geometry);
        showSteps(stepsData);
      }

      function drawRoute(geometry) {
        if (map.getSource("route")) {
          map.getSource("route").setData(geometry);
        } else {
          map.addSource("route", { type: "geojson", data: geometry });
          map.addLayer({
            id: "route",
            type: "line",
            source: "route",
            layout: { "line-join": "round", "line-cap": "round" },
            paint: { "line-color": "#007bff", "line-width": 5 },
          });
        }
      }

      function fitToRoute(geometry) {
        const bounds = new maplibregl.LngLatBounds();
        geometry.coordinates.forEach((c) => bounds.extend(c));
        map.fitBounds(bounds, { padding: 60 });
      }

      // ======== Hi·ªÉn th·ªã h∆∞·ªõng ƒëi chi ti·∫øt ========
      function showSteps(steps) {
        const container = document.getElementById("directions");
        container.innerHTML = "";
        steps.forEach((s, i) => {
          const div = document.createElement("div");
          const instruction = s.maneuver?.instruction || `ƒêi ti·∫øp tr√™n ${s.name}`;
          div.className = "step";
          div.textContent = `B${i + 1}: ${instruction}`;
          div.onmouseenter = () => highlightSegment(s.geometry);
          div.onmouseleave = removeHighlight;
          div.onclick = () => speakInstruction(instruction);
          container.appendChild(div);
        });
      }

      function highlightSegment(geometry) {
        if (!geometry) return;
        if (map.getSource("highlight")) {
          map.getSource("highlight").setData(geometry);
        } else {
          map.addSource("highlight", { type: "geojson", data: geometry });
          map.addLayer({
            id: "highlight",
            type: "line",
            source: "highlight",
            paint: { "line-color": "#ff0000", "line-width": 7 },
          });
        }
      }

      function removeHighlight() {
        if (map.getLayer("highlight")) map.removeLayer("highlight");
        if (map.getSource("highlight")) map.removeSource("highlight");
      }

      function speakInstruction(text) {
        if (!text) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "vi-VN";
        speechSynthesis.speak(utter);
      }

      // ======== GPS m√¥ ph·ªèng ========
      let followMode = false;
      let marker = null;
      let animationId = null;

      function startFollow() {
        if (!routeCoords.length) return alert("H√£y ch·ªçn tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc!");
        if (marker) marker.remove();

        let i = 0;
        marker = new maplibregl.Marker({ color: "orange" }).setLngLat(routeCoords[0]).addTo(map);
        followMode = true;

        function animate() {
          if (!followMode) return;
          const current = routeCoords[i];
          if (!current) return;

          marker.setLngLat(current);
          map.easeTo({ center: current, zoom: 15, duration: 800 });

          // c·∫≠p nh·∫≠t t√™n ƒë∆∞·ªùng hi·ªán t·∫°i
          const nearestStep = stepsData.find((s) =>
            s.geometry.coordinates.some(
              (c) => Math.abs(c[0] - current.lng) < 0.0005 && Math.abs(c[1] - current.lat) < 0.0005
            )
          );
          if (nearestStep) {
            const name = nearestStep.name || "ƒê∆∞·ªùng kh√¥ng x√°c ƒë·ªãnh";
            document.getElementById("currentRoad").innerText = `üöó ƒêang ƒëi tr√™n: ${name}`;
          }

          i++;
          if (i < routeCoords.length) {
            animationId = requestAnimationFrame(animate);
          } else {
            followMode = false;
            cancelAnimationFrame(animationId);
            alert("ƒê√£ ƒë·∫øn ƒë√≠ch!");
          }
        }
        animate();
      }

      function stopFollow() {
        followMode = false;
        cancelAnimationFrame(animationId);
        if (marker) marker.remove();
      }

      document.getElementById("gps-btn").onclick = () => {
        if (followMode) {
          stopFollow();
          document.getElementById("gps-btn").textContent = "üöó GPS Follow";
        } else {
          startFollow();
          document.getElementById("gps-btn").textContent = "‚èπ D·ª´ng GPS";
        }
      };

      // ======== ƒê·ªïi ki·ªÉu b·∫£n ƒë·ªì (v√† kh√¥i ph·ª•c route + markers) ========
      document.getElementById("toggle-style-btn").onclick = () => {
        if (currentStyle === "street") currentStyle = "dark";
        else if (currentStyle === "dark") currentStyle = "satellite";
        else currentStyle = "street";
        map.setStyle(styles[currentStyle]);

        map.once("styledata", () => {
          if (start) {
            startMarker = new maplibregl.Marker({ color: "green" }).setLngLat(start).addTo(map);
          }
          if (end) {
            endMarker = new maplibregl.Marker({ color: "red" }).setLngLat(end).addTo(map);
          }
          if (routeCoords.length) {
            const geojson = {
              type: "LineString",
              coordinates: routeCoords.map((c) => [c.lng, c.lat]),
            };
            drawRoute(geojson);
          }
        });
      };
    </script>
  </body>
</html>
